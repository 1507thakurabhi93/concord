---
boo:
  oneops_host: '{{host}}'
  organization: '{{organization}}'
  api_key: '{{apiKey}}'
  email: '{{email}}'
  environment_name: '{{environmentName}}'
  ip_output: 'json'

assembly:
  name: '{{assemblyName}}'
  auto_gen: false

platforms:
  db:
    pack: oneops/postgresql
    pack_version: '1'
    components:
      os:
        ostype: "centos-7.3"
        repo_list: '["yum-config-manager --add-repo http://repos.walmart.com/mirrored-assets/postgressql/9.6/rhel7/ ; echo gpgcheck=0 >> /etc/yum.repos.d/repos.walmart.com_mirrored-assets_postgressql_9.6_rhel7_.repo"]'
      compute:
        size: 'XL'
      database:
        dbname: 'concord'
        username: 'sa'
        password: 'c0nc0rdDb'
      postgresql:
        version: '9.6'
        port: '5432'
      lb:
        listeners: '["tcp 5432 tcp 5432"]'
        lbmethod: 'roundrobin' 
        ecv_map: '{"5432" : "GET /notused"}' 
      secgroup:
        inbound: '[
          "22 22 tcp 0.0.0.0/0",
          "8080 8080 tcp 0.0.0.0/0",
          "5432 5432 tcp 0.0.0.0/0"
        ]'
      user:
        user-jpise:
          system_account: true
          sudoer: true
          username: 'jpise'
          description: 'Jayesh Pise'
          authorized_keys: '["ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDFo5HbpjfqZOg1DgVavWO1JwTZPsC4iLfk6Mxuh3GYqEIULzBxdYUzqAnMbFegGWODxmFNkIRMMcQcy56U1mf57gkmiPoeFLgpUeKrlBaX6i8PNnxvh0Gne2DXx5aPoYOV5ueLQMwB0D3KKeSXgvKf1eow82MDOFDv4inDvFoHLKDUen2IMX9xFqOX+CtGBAHstfbwiGTekOSut+NhaHQiALcHt1kNq5p4NoQSiDHQTIK+Zq4kE9UlQp3R5YvInBy0+lXoUykIUjI45LoYk6WzqryXuWZQDGSCK0vYODvRXWg6hIlWfcn1T7Z4u4AOwDd8cERGZqeiDVBsG7XZuW1/ jpise@walmartlabs.com"]'
        user-ibodrov:
          system_account: true
          sudoer: true
          username: 'ibodrov'
          description: 'Ivan Bodrov'
          authorized_keys: '["ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCxh2tqHfJnd+jzGkOJ+M6z+y7RNdMrFHpoAa4JcYvgaETeJgxYIhorkL+x0Vz00YoJyy2wGDS2S2NSzjXEV9bnu60pyRDrJbI4gBbmof8fDal/HmgvWcN2axyR/zUnn6BIuwKwEYOygKW11FezmYsfdXueIXgSfFn9sGfd3b+R2ygn5PieVa7KKgR8/djXfsjiM1fA55Z1ZtVig+YqqaVijUkdjKOW2LNhbXBGcD5ocWknmLUXXb2i7Ng/rersd8nD4uSZUCq8pSeZeeQdtr56FNcjh7XyvdTdo83wNCsFPJZMbOQxQVcSl/QP9QdGKFUDAt/Ljrq3svPpHdkDXXEt ibodrov@walmartlabs.com"]'
      fqdn:
         aliases: ["concorddb"]
          
  agent:
    pack: oneops/docker
    pack_version: '1'
    variables:
      docker-repo: '{{dockerRepo}}'
      docker-root: '{{dockerRoot}}'
      data-volume: '{{dataVolume}}'
    components:
      compute:
        size: 'L'

      docker_engine:
        attachments:
          docker-script:
            path: '{{dataVolume}}/docker-script.sh'
            run_on: 'after-add,after-update,after-replace,on-demand'
            priority: 1
            exec_cmd: 'sudo chmod 755 /data/docker-script.sh; sudo /data/docker-script.sh'
            content: |
              docker pull docker.prod.walmart.com/walmartlabs/concord-agent:{{concordVersion}}

              docker rm -f agent

              docker run -d -p 8002:8002 \
              -v {{dataVolume}}/tmp:/tmp --name agent \
              docker.prod.walmart.com/walmartlabs/concord-agent:{{concordVersion}}
      user:
        user-jpise:
          system_account: true
          sudoer: true
          username: 'jpise'
          description: 'Jayesh Pise'
          authorized_keys: '["ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDFo5HbpjfqZOg1DgVavWO1JwTZPsC4iLfk6Mxuh3GYqEIULzBxdYUzqAnMbFegGWODxmFNkIRMMcQcy56U1mf57gkmiPoeFLgpUeKrlBaX6i8PNnxvh0Gne2DXx5aPoYOV5ueLQMwB0D3KKeSXgvKf1eow82MDOFDv4inDvFoHLKDUen2IMX9xFqOX+CtGBAHstfbwiGTekOSut+NhaHQiALcHt1kNq5p4NoQSiDHQTIK+Zq4kE9UlQp3R5YvInBy0+lXoUykIUjI45LoYk6WzqryXuWZQDGSCK0vYODvRXWg6hIlWfcn1T7Z4u4AOwDd8cERGZqeiDVBsG7XZuW1/ jpise@walmartlabs.com"]'
        user-ibodrov:
          system_account: true
          sudoer: true
          username: 'ibodrov'
          description: 'Ivan Bodrov'
          authorized_keys: '["ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCxh2tqHfJnd+jzGkOJ+M6z+y7RNdMrFHpoAa4JcYvgaETeJgxYIhorkL+x0Vz00YoJyy2wGDS2S2NSzjXEV9bnu60pyRDrJbI4gBbmof8fDal/HmgvWcN2axyR/zUnn6BIuwKwEYOygKW11FezmYsfdXueIXgSfFn9sGfd3b+R2ygn5PieVa7KKgR8/djXfsjiM1fA55Z1ZtVig+YqqaVijUkdjKOW2LNhbXBGcD5ocWknmLUXXb2i7Ng/rersd8nD4uSZUCq8pSeZeeQdtr56FNcjh7XyvdTdo83wNCsFPJZMbOQxQVcSl/QP9QdGKFUDAt/Ljrq3svPpHdkDXXEt ibodrov@walmartlabs.com"]'

      secgroup:
        inbound: '[
          "22 22 tcp 0.0.0.0/0",
          "8002 8002 tcp 0.0.0.0/0"
        ]'

  server:
    pack: oneops/docker
    pack_version: '1'
    variables:
      docker-repo: '{{dockerRepo}}'
      docker-root: '{{dockerRoot}}'
      data-volume: '{{dataVolume}}'
    components:
      compute:
        size: 'L'

      docker_engine:
        attachments:
          docker-script:
                path: '{{dataVolume}}/docker-script.sh'
                run_on: 'after-add,after-update,after-replace,on-demand'
                priority: 1
                exec_cmd: 'sudo chmod 755 /data/docker-script.sh; sudo /data/docker-script.sh'
                content: |
                  docker pull docker.prod.walmart.com/walmartlabs/concord-server:{{concordVersion}}
                  docker pull docker.prod.walmart.com/walmartlabs/concord-console:{{concordVersion}}

                  docker rm -f server console

                  docker run -d -p 8001:8001 \
                  --name server \
                  -v {{dataVolume}}/data:/opt/concord/data \
                  -v {{dataVolume}}/tmp:/tmp \
                  -e 'AGENT_URL=http://agent:8002' \
                  -e 'DB_URL=jdbc:postgresql://db:5432/concord' \
                  -e 'DB_DIALECT=POSTGRES' \
                  -e 'DB_DRIVER=org.postgresql.Driver' \
                  -e 'DB_USERNAME=sa' \
                  -e 'DB_PASSWORD=c0nc0rdDb' \
                  -e 'LDAP_CFG=/opt/concord/data/conf/ldap.properties' \
                  -e 'LOG_STORE_DIR=/opt/concord/data/logs' \
                  -e 'FORM_SERVER_DIR=/opt/concord/data/formserv' \
                  -e 'PAYLOAD_DIR=/opt/concord/data/payload' \
                  docker.prod.walmart.com/walmartlabs/concord-server:{{concordVersion}}

                  docker run -d -p 8080:8080 \
                  --name console \
                  -v {{dataVolume}}/data/console/landing:/opt/concord/console/landing:ro \
                  --link server \
                  docker.prod.walmart.com/walmartlabs/concord-console:{{concordVersion}}

      file:
         ldap-conf:
                content: |
                  url=ldap://honts0102.homeoffice.wal-mart.com:389
                  searchBase=DC=homeoffice,DC=Wal-Mart,DC=com
                  principalSuffix=@homeoffice.wal-mart.com
                  principalSearchFilter=(&(objectCategory=Person)(sAMAccountName={0}))
                  systemUsername={{ldapUserName}}
                  systemPassword={{ldapPassword}}
                  exposeAttributes=company,mail
                path: '{{dataVolume}}/data/conf/ldap.properties'
             
      storage:
        storage:
          size: "80G"
          volume_type: "STANDARD1"

      volume:
        vol-docker:
          size: "20%FREE"
                  
      user:
        user-jpise:
          system_account: true
          sudoer: true
          username: 'jpise'
          description: 'Jayesh Pise'
          authorized_keys: '["ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDFo5HbpjfqZOg1DgVavWO1JwTZPsC4iLfk6Mxuh3GYqEIULzBxdYUzqAnMbFegGWODxmFNkIRMMcQcy56U1mf57gkmiPoeFLgpUeKrlBaX6i8PNnxvh0Gne2DXx5aPoYOV5ueLQMwB0D3KKeSXgvKf1eow82MDOFDv4inDvFoHLKDUen2IMX9xFqOX+CtGBAHstfbwiGTekOSut+NhaHQiALcHt1kNq5p4NoQSiDHQTIK+Zq4kE9UlQp3R5YvInBy0+lXoUykIUjI45LoYk6WzqryXuWZQDGSCK0vYODvRXWg6hIlWfcn1T7Z4u4AOwDd8cERGZqeiDVBsG7XZuW1/ jpise@walmartlabs.com"]'
        user-ibodrov:
          system_account: true
          sudoer: true
          username: 'ibodrov'
          description: 'Ivan Bodrov'
          authorized_keys: '["ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCxh2tqHfJnd+jzGkOJ+M6z+y7RNdMrFHpoAa4JcYvgaETeJgxYIhorkL+x0Vz00YoJyy2wGDS2S2NSzjXEV9bnu60pyRDrJbI4gBbmof8fDal/HmgvWcN2axyR/zUnn6BIuwKwEYOygKW11FezmYsfdXueIXgSfFn9sGfd3b+R2ygn5PieVa7KKgR8/djXfsjiM1fA55Z1ZtVig+YqqaVijUkdjKOW2LNhbXBGcD5ocWknmLUXXb2i7Ng/rersd8nD4uSZUCq8pSeZeeQdtr56FNcjh7XyvdTdo83wNCsFPJZMbOQxQVcSl/QP9QdGKFUDAt/Ljrq3svPpHdkDXXEt ibodrov@walmartlabs.com"]'
      secgroup:
        inbound: '[
          "22 22 tcp 0.0.0.0/0",
          "8080 8080 tcp 0.0.0.0/0",
          "8081 8081 tcp 0.0.0.0/0",
          "8001 8001 tcp 0.0.0.0/0"
        ]'

  static:
    pack: oneops/custom
    pack_version: '1'
    components:
      compute:
        size: 'S'

      os:
        ostype: centos-7.2

      user:
        user-jpise:
          system_account: true
          sudoer: true
          username: 'jpise'
          description: 'Jayesh Pise'
          authorized_keys: '["ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDFo5HbpjfqZOg1DgVavWO1JwTZPsC4iLfk6Mxuh3GYqEIULzBxdYUzqAnMbFegGWODxmFNkIRMMcQcy56U1mf57gkmiPoeFLgpUeKrlBaX6i8PNnxvh0Gne2DXx5aPoYOV5ueLQMwB0D3KKeSXgvKf1eow82MDOFDv4inDvFoHLKDUen2IMX9xFqOX+CtGBAHstfbwiGTekOSut+NhaHQiALcHt1kNq5p4NoQSiDHQTIK+Zq4kE9UlQp3R5YvInBy0+lXoUykIUjI45LoYk6WzqryXuWZQDGSCK0vYODvRXWg6hIlWfcn1T7Z4u4AOwDd8cERGZqeiDVBsG7XZuW1/ jpise@walmartlabs.com"]'
        user-ibodrov:
          system_account: true
          sudoer: true
          username: 'ibodrov'
          description: 'Ivan Bodrov'
          authorized_keys: '["ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCxh2tqHfJnd+jzGkOJ+M6z+y7RNdMrFHpoAa4JcYvgaETeJgxYIhorkL+x0Vz00YoJyy2wGDS2S2NSzjXEV9bnu60pyRDrJbI4gBbmof8fDal/HmgvWcN2axyR/zUnn6BIuwKwEYOygKW11FezmYsfdXueIXgSfFn9sGfd3b+R2ygn5PieVa7KKgR8/djXfsjiM1fA55Z1ZtVig+YqqaVijUkdjKOW2LNhbXBGcD5ocWknmLUXXb2i7Ng/rersd8nD4uSZUCq8pSeZeeQdtr56FNcjh7XyvdTdo83wNCsFPJZMbOQxQVcSl/QP9QdGKFUDAt/Ljrq3svPpHdkDXXEt ibodrov@walmartlabs.com"]'

      secgroup:
        inbound: '[
          "22 22 tcp 0.0.0.0/0",
          "80 80 tcp 0.0.0.0/0"
        ]'

environment:
  global_dns: true
  subdomain: '{{environmentName}}.{{assemblyName}}.{{organization}}'
  availability: Reduandant 
  profile: 'PROD'
  debug: false
  autoscale: false
  autorepair: false
  autoreplace: false
  platforms:
    server:
      availability: Single
    db:
      availability: Redundant
    agent:
      availability: Single
  clouds:
    prod-cdc6:
      priority: '1'
      dpmt_order: '1'
      pct_scale: '100'
    prod-cdc7:
      priority: '2'
      adminstatus: 'offline'
      dpmt_order: '1'
      pct_scale: '100'

