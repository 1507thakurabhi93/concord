language: workflow

envs:
  global:
    variables:
      MVN_SETTINGS: .looper/settings.xml
      DEPLOYMENT_USERNAME: "%{credentials.username('walmart-deployment')}"
      DEPLOYMENT_PASSWORD: "%{credentials.password('walmart-deployment')}"

      # until we will be able to run docker images from mvn directly on a looper's slave
      CI_DB_HOST: "docker.dev.concord-ci.devtools.prod.walmart.com"
      CI_DB_USERNAME: "%{credentials.username('concordCiDb')}"
      CI_DB_PASSWORD: "%{credentials.password('concordCiDb')}"
      DOCKER_HOST: "tcp://docker.dev.concord-ci.devtools.prod.walmart.com:2375"
      DOCKER_API_VERSION: "1.22"

tools:
  jdk: 8
  maven: 3.3.9
  sonarscanner: 3.0.3.778

docker:
  - name: "concord-looper-agent"
    image: "docker.prod.walmart.com/walmartlabs/concord-looper-agent:latest"

flows:
  runsonar:
    - sonar("Sonar"):
      - (name sonar) mvn -Plooper -Pwalmart -e -B -fae $SONAR_MAVEN_GOAL
      - (name hygieiaPublish) hygieia.publishSonar()

  build:
    - node(docker-daemon):
      - dockerAgent(concord-looper-agent):
        - call: cleanup
        - (name build) mvn -U -B -s $MVN_SETTINGS clean install -Plooper -Pwalmart

  build_and_deploy:
    - node(docker-daemon):
      - dockerAgent(concord-looper-agent):
        - call: cleanup
        - (name build) mvn -U -B -s $MVN_SETTINGS clean deploy -Plooper -Pwalmart
        - (name hygieiaPublish) hygieia.publishBuild()

  cleanup:
    - (name cleanup) docker rm -f $(docker ps -aq) &> /dev/null || true

  default:
    - call: build_and_deploy
    - call: runsonar

  pr:
    - call: build