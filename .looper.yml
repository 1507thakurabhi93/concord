language: workflow

envs:
  global:
    variables:
      MVN_SETTINGS: .looper/settings.xml
      DEPLOYMENT_USERNAME: "%{credentials.username('walmart-deployment')}"
      DEPLOYMENT_PASSWORD: "%{credentials.password('walmart-deployment')}"
      # this should be provided by looper, but it never will
      DOCKER_HOST: tcp://localhost:2375
      DOCKER_REGISTRY: docker.prod.walmart.com

tools:
  jdk: 8
  maven: 3.3.9

flows:
  runsonar:
    - sonar("Sonar"):
      - (name sonar) mvn -Plooper -e -B -fae $SONAR_MAVEN_GOAL

  build:
    - (name build) mvn -U -B -s $MVN_SETTINGS clean deploy -Plooper

# won't work in the current version of looper
#  it:
#    - (name ITs) mvn -U -B clean install -Plooper -Pit -Pdocker -Ddocker.host.addr=`/sbin/ip -o -4 addr list | grep docker0 | sed 's/.*inet //;s/\/.*//'`

#  docker_push:
#     - (name docker-images) echo "And this is where I'd put my docker:push... if I had credentials!"

  default (on linux):
    - call: build
    - call: runsonar

  pr (on linux):
    - call: build